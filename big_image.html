<html>
  <head>
    <meta charset="utf-8" />
    <title>Generate a token</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="Leaflet.BigImage/dist/Leaflet.BigImage.min.css">

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <!-- Load Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/geojson-vt@3.2.0/geojson-vt.js"></script>
    <script src="lib/leaflet-geojson-vt.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4.0.1/dist/esri-leaflet-vector.js" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-image@0.4.0/leaflet-image.min.js"></script>
    <script src="Leaflet.BigImage/dist/Leaflet.BigImage.min.js"></script>

    <style>
      html,
      body,
      #map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color: #323232;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="images"></div>
    <img id="mainImg" src="" alt="">
    <script>
      const apiKey = "AAPK1953b729b5594134b3c0637a544f93b4ujYHb9Mv80eLTm6Fr9dPeq9E5fV-G_yBqXoYvhKtYxLePiMnRVHx0T8qn3Mifpz0";
      if (!window.location.origin) {
        window.location.origin =
          window.location.protocol + "//" + window.location.hostname + (window.location.port ? ":" + window.location.port : "");
      }

      // let map = L.map("map").setView([22.369860,90.283092], 16);
      let map = L.map("map").setView([22.362860,90.283092], 16);
      L.control.bigImage({position: 'topright'}).addTo(map);

     /*  L.esri.Vector.vectorBasemapLayer("ArcGIS:LightGray:Base", {
        apikey: apiKey
      }).addTo(map); */
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

      function serverAuth(callback) { //To acess the dynamic map layer
          L.esri.post(
            "https://www.arcgis.com/sharing/generateToken", //https://[root]/generateToken (POST only)
            {
              username: "mah_gis2023",
              password: "mah_gis12345!",
              f: "json",
              expiration: 86400,
              client: "referer",
              referer: window.location.origin
            },
            callback
          );
        }

        let populateMapJson = {
          "type": "FeatureCollection",
          "features": []
        };

        let count = 0;

      function setMapJson(jsonVal) {
          populateMapJson.features.push(...jsonVal);
          count++;
          // console.log('testJson ',testJson,'count ',count);
          if (count == 1) {
            console.log('populateMapJson ', populateMapJson);
         
          }
        }
      
      serverAuth(function (error, response) {
          if (error) {
            return;
          }
          const dl = L.esri
            .dynamicMapLayer({
              url: "https://services9.arcgis.com/JrBT6JVVu83wFjjB/arcgis/rest/services/Itbaria_Mauza/FeatureServer",
              opacity: 1,
              token: response.token
            })
            .addTo(map);



          var mapSheet_1 = L.esri.featureLayer({
            url: 'https://services9.arcgis.com/JrBT6JVVu83wFjjB/arcgis/rest/services/Itbaria_Mauza/FeatureServer/1',
            token: response.token,
            where:"Mouza_Dag='2122'"

          });
          console.log('mapSheet_1 ',mapSheet_1);
          var mapSheet_2 = L.esri.featureLayer({
            url: 'https://services9.arcgis.com/JrBT6JVVu83wFjjB/arcgis/rest/services/Itbaria_Mauza/FeatureServer/2',
            token: response.token,

          });

          var mapSheet_3 = L.esri.featureLayer({
            url: 'https://services9.arcgis.com/JrBT6JVVu83wFjjB/arcgis/rest/services/Itbaria_Mauza/FeatureServer/3',
            token: response.token,

          });

          var mapSheet_4 = L.esri.featureLayer({
            url: 'https://services9.arcgis.com/JrBT6JVVu83wFjjB/arcgis/rest/services/Itbaria_Mauza/FeatureServer/4',
            token: response.token,


          });

          
/*             console.log('data ', L.geoJSON(features[0]).getBounds());

          if (features[0]['id']) {
            var bbox = L.rectangle(L.geoJSON(features[0]).getBounds(), { color: 'red', weight: 1 }).addTo(map);
            console.log('features ', features[0]['id']);
            L.geoJSON(features[0]).addTo(map);
          }


          L.geoJSON(mapSheet_1).addTo(map); */

          let filteredBound=[];
          var mapBbox = map.getBounds();
          
          function bboxFilter(feature) {
            //2291,2892,2270(perfect to bug),2341,2998(anamoly)
            if(feature.properties.Mouza_Dag=='2998'){
              return true;
            }
            else{
              return false;
            }
        }
        let filterVal='';
        var intersection='';

   

          function bboxFilterContain(feature) {
            
            var polylatlng = new L.polygon([]);
            var coords = feature.geometry.coordinates;
            coords[0].forEach(function (coord) {
              var lat = coord[1];
              var lng = coord[0];
              polylatlng.addLatLng(L.latLng([lat, lng]));
            });
          
              
            
            var bboxPolygon = turf.bboxPolygon(filterVal.getBounds().toBBoxString().split(",").map(parseFloat));
            var intersection = turf.intersect(feature, bboxPolygon);
            

/* 
            if (filterVal.getBounds().contains(polylatlng.getBounds()._northEast) || filterVal.getBounds().contains(polylatlng.getBounds()._southWest)) {
              // console.log('filteredBound ',filteredBound);
              console.log('feature ',feature.properties.Mouza_Dag);
             return true;
            } */
            if (intersection !=null) {
              // console.log('filteredBound ',filteredBound);
              console.log('feature ',feature.properties.Mouza_Dag);
             
             return true;
            }
            else{
              return false;
            }
        }

        

          mapSheet_1.query().run(function (error, featureCollection) {
            var count=0;
            if (error) {
              console.log(error);
            }
            else {
              var features = featureCollection.features;
              setMapJson(features);
           

             var filteredData=L.geoJSON(features,{
                filter:bboxFilter,
              });

              console.log('filteredData ',filteredData.getBounds().getSouthWest());
              filteredBound=filteredData.getBounds();
              filteredBound.getSouthWest().lat=filteredBound.getSouthWest().lat-0.000111;
              filteredBound.getSouthWest().lng=filteredBound.getSouthWest().lng-0.000111;
              filteredBound.getNorthEast().lat=filteredBound.getNorthEast().lat+0.000111;
              filteredBound.getNorthEast().lng=filteredBound.getNorthEast().lng+0.000111;
              
              filterVal= L.rectangle(filteredBound, { color: 'red', weight: 1 ,fillOpacity:0}).addTo(map);

              L.geoJSON(features,{
                filter:bboxFilterContain,
              }).addTo(map);
       

            
            }
          });
          mapSheet_2.query().run(function (error, featureCollection) {
            if (error) {
              console.log(error);
            }
            else {
              var features = featureCollection.features;
              // setMapJson(features);

            }
          });
          mapSheet_3.query().run(function (error, featureCollection) {
            if (error) {
              console.log(error);
            }
            else {
              var features = featureCollection.features;
              // setMapJson(features);

            }
          });
          mapSheet_4.query().run(function (error, featureCollection) {
            if (error) {
              console.log(error);
            }
            else {
              var features = featureCollection.features;
              // setMapJson(features);

            }
          });


          /* leasehold.on('ready', iterateFeatures);
            function iterateFeatures() {
                leasehold.eachFeature(function (layer) {
                    console.log(layer.feature);
                });
            } */
          dl.on("authenticationrequired", function (e) {
            serverAuth(function (error, response) {
              if (error) {
                return;
              }
              e.authenticate(response.token);
            });
          });
        });

      


       /*  setTimeout((
            leafletImage(map, function (error, canvas) {
              if (error) {
                console.log(error);
              } else {

                var dataUrl = canvas.toDataURL();

                var img = document.createElement('img');
                var dimensions = map.getSize();
                img.width = dimensions.x;
                img.height = dimensions.y;
                img.src = canvas.toDataURL();
                document.getElementById('images').innerHTML = '';
                document.getElementById('images').appendChild(img);

                document.getElementById("mainImg").src = dataUrl;

                localStorage.setItem('map_data_url', dataUrl);
              }
            })),5000) */


    </script>
  </body>
</html>